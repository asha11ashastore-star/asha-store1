"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[640],{4640:function(e,t,o){o.r(t),o.d(t,{AuthProvider:function(){return l},useAuth:function(){return i}});var r=o(7437),a=o(2265),s=o(9487);let n=(0,a.createContext)();function l(e){let{children:t}=e,[o,l]=(0,a.useState)(null),[i,c]=(0,a.useState)(!0);(0,a.useEffect)(()=>{(async()=>{try{let r=s.Z.getToken(),a=localStorage.getItem("user_data");if(console.log("\uD83D\uDD10 Auth check - Token exists:",!!r,"| SavedUser exists:",!!a),!r||!a){console.log("\uD83D\uDD10 localStorage empty, checking sessionStorage backup...");let e=sessionStorage.getItem("auth_token_backup"),t=sessionStorage.getItem("user_data_backup");e&&t&&(console.log("\uD83D\uDD10 ✅ RESTORING from sessionStorage backup!"),localStorage.setItem("auth_token",e),localStorage.setItem("user_data",t),r=e,a=t,console.log("\uD83D\uDD10 ✅ Restored user:",JSON.parse(t).email))}if(r)try{console.log("\uD83D\uDD0D Token found - verifying with API..."),console.log("   Token (first 10 chars):",r.substring(0,10)+"...");let e=await s.Z.getCurrentUser();if(console.log("✅ User verified with API:",e.email),console.log("   User ID:",e.id),console.log("   Username:",e.username),l(e),localStorage.setItem("user_data",JSON.stringify(e)),console.log("\uD83D\uDCBE Updated localStorage with verified user:",e.email),a)try{let t=JSON.parse(a);t.email!==e.email&&(console.warn("⚠️ SECURITY WARNING: localStorage had DIFFERENT user!"),console.warn("   localStorage had:",t.email),console.warn("   API verified:",e.email),console.warn("   This means auth data was stale!"),console.log("✅ FIXED: Using API-verified user:",e.email))}catch(e){}}catch(r){var e,t,o;if(console.error("❌ API verification failed:",r),console.error("❌ Error message:",r.message),console.error("❌ Error details:",JSON.stringify(r)),(null===(e=r.message)||void 0===e?void 0:e.includes("401"))||(null===(t=r.message)||void 0===t?void 0:t.includes("Unauthorized"))||(null===(o=r.message)||void 0===o?void 0:o.includes("Invalid token")))console.log("\uD83D\uDD10 Token is TRULY invalid (401), clearing session"),s.Z.logout(),localStorage.removeItem("user_data"),l(null);else if(console.warn("⚠️ API call failed but NOT 401 - keeping session!"),console.warn("⚠️ This could be network issue, CORS, or server down"),console.warn("⚠️ Using localStorage as fallback to keep user logged in"),a)try{let e=JSON.parse(a);l(e),console.log("✅ User kept logged in from localStorage:",e.email),console.log("✅ User ID:",e.id),console.log("✅ Will retry API verification on next navigation")}catch(e){console.error("❌ Failed to parse saved user data:",e)}else console.warn("⚠️ Have token but no saved user data - keeping token"),console.warn("⚠️ Will retry to fetch user on next API call")}else console.log("ℹ️ No token found - user not logged in"),a&&(console.log("\uD83E\uDDF9 Clearing stale user data from localStorage"),localStorage.removeItem("user_data")),l(null)}catch(e){console.error("❌ Auth check failed:",e),l(null)}finally{c(!1)}})()},[]);let u=async(e,t)=>{try{console.log("\uD83D\uDD10 LOGIN ATTEMPT:",e),console.log("\uD83E\uDDF9 Clearing all previous auth data..."),localStorage.removeItem("user_data"),localStorage.removeItem("auth_token"),s.Z.setToken(null),l(null),console.log("\uD83D\uDCE1 Calling login API...");let o=await s.Z.login(e,t);console.log("✅ Login API response received, token:",o.access_token?"YES":"NO"),console.log("\uD83D\uDCE1 Fetching user data with new token...");let r=await s.Z.getCurrentUser();if(console.log("✅ User data received:",r.email),r.email.toLowerCase()!==e.toLowerCase())throw console.error("❌ SECURITY ERROR: Logged in as different user!"),console.error("   Expected:",e),console.error("   Got:",r.email),Error("Authentication mismatch - please try again");return l(r),localStorage.setItem("user_data",JSON.stringify(r)),console.log("✅ User logged in and verified:",r.email),console.log("\uD83D\uDCBE Saved to localStorage:",r.email),{success:!0,user:r}}catch(e){throw console.error("❌ Login failed:",e),localStorage.removeItem("user_data"),localStorage.removeItem("auth_token"),l(null),e}},d=async e=>{try{let t=await s.Z.register(e);return{success:!0,data:t}}catch(e){throw e}},g=async()=>{try{console.log("\uD83D\uDEAA LOGOUT - Clearing all auth data...");let e=(null==o?void 0:o.email)||"unknown";await s.Z.logout(),localStorage.removeItem("user_data"),localStorage.removeItem("auth_token"),l(null),console.log("✅ User logged out:",e),console.log("\uD83E\uDDF9 All auth data cleared from localStorage")}catch(e){console.error("Logout error:",e),localStorage.removeItem("user_data"),localStorage.removeItem("auth_token"),l(null)}},m=async()=>{try{console.log("\uD83D\uDD04 Refreshing user data from API...");let e=await s.Z.getCurrentUser();return l(e),localStorage.setItem("user_data",JSON.stringify(e)),console.log("✅ User data refreshed successfully:",e.email),console.log("✅ User ID:",e.id),e}catch(t){console.error("⚠️ Failed to refresh user from API:",t);let e=localStorage.getItem("user_data");if(e)try{let t=JSON.parse(e);return console.log("⚠️ Using cached user data from localStorage:",t.email),l(t),t}catch(e){console.error("❌ Failed to parse saved user data:",e)}throw console.error("❌ No user data available - refresh failed completely"),t}};return(0,r.jsx)(n.Provider,{value:{user:o,isLoading:i,login:u,register:d,logout:g,refreshUser:m,isAuthenticated:!!o},children:t})}function i(){let e=(0,a.useContext)(n);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},9487:function(e,t,o){let r=o(2601).env.NEXT_PUBLIC_API_BASE_URL||"http://localhost:8000";class a{setToken(e){e?(console.log("\uD83D\uDD11 Setting token in localStorage (first 10 chars):",e.substring(0,10)+"..."),localStorage.setItem("auth_token",e)):(console.log("\uD83D\uDDD1️ Removing token from localStorage"),localStorage.removeItem("auth_token"))}getToken(){{let e=localStorage.getItem("auth_token");return e?console.log("\uD83D\uDD11 Retrieved token from localStorage (first 10 chars):",e.substring(0,10)+"..."):console.log("\uD83D\uDD11 No token in localStorage"),e}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=e.includes("?")?"&":"?",r=new Date().getTime(),a="".concat(this.baseURL).concat(e).concat(o,"_t=").concat(r),s=this.getToken();console.log("\uD83D\uDCE1 API Request: ".concat(t.method||"GET"," ").concat(e)),s?console.log("\uD83D\uDCE1   → Using token (first 10): ".concat(s.substring(0,10),"...")):console.log("\uD83D\uDCE1   → No token (public request)");let n={cache:"no-store",headers:{"Content-Type":"application/json","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0",...t.headers},...t};s&&(n.headers.Authorization="Bearer ".concat(s));try{let e=await fetch(a,n),t=await e.json();if(!e.ok){let e="API request failed";throw t.detail?e=Array.isArray(t.detail)?t.detail.map(e=>e.msg).join(", "):t.detail:t.message&&(e=t.message),Error(e)}return t}catch(e){throw console.error("API Error:",e),e}}async login(e,t){try{console.log("\uD83D\uDD10 API Service - Login attempt for:",e);let o=await this.request("/api/v1/auth/login",{method:"POST",body:JSON.stringify({email:e,password:t})});return o.access_token?(console.log("\uD83D\uDD10 API Service - Login successful for:",e),console.log("\uD83D\uDD10 API Service - Received token (first 10):",o.access_token.substring(0,10)+"..."),this.setToken(o.access_token),console.log("\uD83D\uDD10 API Service - Token stored in localStorage")):console.error("\uD83D\uDD10 API Service - No token in response!"),o}catch(t){throw console.error("\uD83D\uDD10 API Service - Login failed for:",e,t),t}}async register(e){return await this.request("/api/v1/auth/register",{method:"POST",body:JSON.stringify(e)})}async logout(){this.setToken(null)}async getCurrentUser(){console.log("\uD83D\uDC64 API Service - Fetching current user...");let e=await this.request("/api/v1/auth/me");return console.log("\uD83D\uDC64 API Service - Current user:",e.email),console.log("\uD83D\uDC64 API Service - User ID:",e.id),console.log("\uD83D\uDC64 API Service - Username:",e.username),e}async getProducts(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new URLSearchParams(e).toString();return await this.request("/api/v1/products-fixed?".concat(t))}async getAllProducts(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new URLSearchParams(e).toString(),o=await this.request("/api/v1/products/".concat(t?"?"+t:""));return o.items?{data:o.items.map(e=>({...e,status:e.status?e.status.replace("ProductStatus.","").toLowerCase():"draft",category:e.category?e.category.replace("Category.",""):e.category})),...o}:o}async getProduct(e){return await this.request("/api/v1/products/".concat(e))}async searchProducts(e){return await this.request("/api/v1/products/search?q=".concat(encodeURIComponent(e)))}async getCart(){return await this.request("/api/v1/cart")}async addToCart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return await this.request("/api/v1/cart/add",{method:"POST",body:JSON.stringify({product_id:e,quantity:t})})}async updateCartItem(e,t){return await this.request("/api/v1/cart/update/".concat(e),{method:"PUT",body:JSON.stringify({quantity:t})})}async removeFromCart(e){return await this.request("/api/v1/cart/remove/".concat(e),{method:"DELETE"})}async clearCart(){return await this.request("/api/v1/cart/clear",{method:"DELETE"})}async createOrder(e){let t={customer_name:e.customer_name,customer_email:e.customer_email,customer_phone:e.customer_phone,shipping_address:e.shipping_address,notes:e.notes||null,items:e.items.map(e=>({product_id:e.product_id,quantity:e.quantity,unit_price:parseFloat(e.price||e.unit_price)}))};return await this.request("/api/v1/orders/customer",{method:"POST",body:JSON.stringify(t)})}async getOrders(){return await this.request("/api/v1/orders")}async getOrder(e){return await this.request("/api/v1/orders/".concat(e))}async createPaymentOrder(e){return await this.request("/api/v1/payment/create-order",{method:"POST",body:JSON.stringify({order_id:e})})}async verifyPayment(e){return await this.request("/api/v1/payment/verify",{method:"POST",body:JSON.stringify(e)})}async initiatePayment(e){try{let t=await this.createOrder(e),o=await this.createPaymentOrder(t.id);return new Promise((r,a)=>{let s={key:"FVZPTn18225397949705",amount:o.amount,currency:o.currency,name:"Aशा - Grace Woven by Asha Dhaundiyal",description:"Handwoven Sarees & Traditional Wear",order_id:o.razorpay_order_id,handler:async e=>{try{let o=await this.verifyPayment({razorpay_order_id:e.razorpay_order_id,razorpay_payment_id:e.razorpay_payment_id,razorpay_signature:e.razorpay_signature});r({success:!0,order:t,payment:e,verification:o})}catch(e){a({success:!1,error:e.message})}},prefill:{name:e.customer_name||"",email:e.customer_email||"",contact:e.customer_phone||""},theme:{color:"#8B4513"},modal:{ondismiss:()=>{a({success:!1,error:"Payment cancelled by user"})}}};window.Razorpay?new window.Razorpay(s).open():a({success:!1,error:"Razorpay not loaded"})})}catch(e){throw e}}async subscribeNewsletter(e){return await this.request("/api/v1/newsletter/subscribe",{method:"POST",body:JSON.stringify({email:e})})}async submitContactForm(e){return await this.request("/api/v1/contact",{method:"POST",body:JSON.stringify(e)})}constructor(){this.baseURL=r}}let s=new a;t.Z=s}}]);